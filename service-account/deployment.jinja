{% set domain = env['project'].split(':') %}
{% if domain|length >1 %}
{% set projectName = domain[1] + '.' + domain[0] %}
{% else %}
{% set projectName = domain[0] %}
{% endif %}
{% set roles = properties['roles'] %}

resources:
- name: {{ projectName }}-svc-account
  type: iam.v1.serviceAccount
  properties:
    accountId: {{ projectName }}-svc-account
    displayName: {{ projectName }}-svc-account
{% for role in roles %}
- name: bind-iam-policy
  type: gcp-types/cloudresourcemanager-v1:virtual.projects.iamMemberBinding
  properties:
    resource: project_id
    role: {{ role }}
    member: serviceAccount:$(ref.{{ projectName }}-svc-account.email)
{% endfor %}

outputs:
- name: serviceAccount
  value: $(ref.{{ projectName }}-svc-account.email)